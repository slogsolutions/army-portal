{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Military Examination Portal</title>
    <link href="{% static 'css/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> -->
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
        :root {
            --army-green: #2c4c2c;
            --army-dark-green: #1a2e1a;
            --army-gold: #c8b072;
            --army-tan: #d6c28e;
            --army-light: #3d6b3d;
            --text-light: #f0f0f0;
            --text-muted: #cccccc;
            --card-bg: rgba(34, 49, 34, 0.92);
            --sidebar-bg: rgba(26, 46, 26, 0.95);
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --current: #2196f3;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a2e1a url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2' fill='%233d6b3d' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Enhanced Fullscreen Controls Prevention */
        body:fullscreen,
        body:-webkit-full-screen,
        body:-moz-full-screen {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden;
        }
        
        /* Hide fullscreen controls completely */
        body:fullscreen::backdrop,
        body:-webkit-full-screen::backdrop,
        body:-moz-full-screen::backdrop {
            background: #000;
        }

        /* Block top area hover effects */
        body:fullscreen::before,
        body:-webkit-full-screen::before,
        body:-moz-full-screen::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: transparent;
            z-index: 9999999;
            pointer-events: auto;
            display: block;
        }

        /* Force hide any browser UI */
        body:fullscreen *:hover,
        body:-webkit-full-screen *:hover,
        body:-moz-full-screen *:hover {
            cursor: default !important;
        }
        
        .exam-container {
            display: flex;
            flex: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            padding: 20px 15px;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            z-index: 10;
            border-right: 2px solid var(--army-gold);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(200, 176, 114, 0.3);
        }
        
        .sidebar-header h2 {
            color: var(--army-gold);
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .time-remaining {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid var(--army-gold);
        }
        
        .time-remaining span {
            font-weight: bold;
            color: var(--army-gold);
            font-size: 1.4rem;
            display: block;
            margin-top: 5px;
            letter-spacing: 1px;
        }
        
        .question-nav-container {
            flex: 1;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .question-btn {
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: var(--army-dark-green);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .question-btn:hover {
            transform: scale(1.1);
            border-color: var(--army-gold);
        }
        
        .question-btn.current {
            border: 2px solid var(--current);
            background: var(--current);
            color: white;
            box-shadow: 0 0 8px var(--current);
        }
        
        .question-btn.answered {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .question-btn.flagged {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        
        .question-status {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 6px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .status-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .status-answered {
            background: var(--success);
        }
        
        .status-flagged {
            background: var(--danger);
        }
        
        .status-current {
            background: var(--current);
        }
        
        .status-not-answered {
            background: var(--army-dark-green);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: rgba(26, 46, 26, 0.7);
        }
        
        .exam-header {
            background: var(--card-bg);
            padding: 18px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--army-gold);
        }
        
        .exam-title {
            color: var(--army-gold);
            margin: 0;
            font-weight: 600;
            font-size: 1.6rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .question-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
            border: 1px solid rgba(200, 176, 114, 0.2);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 1.2rem;
            color: var(--text-light);
            flex: 1;
            line-height: 1.5;
        }
        
        .marks-badge {
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--army-dark-green);
            color: var(--army-gold);
            white-space: nowrap;
            border: 1px solid var(--army-gold);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .options-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .form-check {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 0;
            border-radius: 8px;
            border: 1px solid rgba(200, 176, 114, 0.2);
            background: rgba(26, 46, 26, 0.7);
            transition: all 0.2s ease;
        }
        
        .form-check:hover {
            background: rgba(40, 70, 40, 0.8);
            border-color: var(--army-gold);
        }
        
        .form-check-input {
            margin-right: 12px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .form-check-label {
            width: 100%;
            cursor: pointer;
            font-size: 1.05rem;
            color: var(--text-light);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(200, 176, 114, 0.3);
            background: rgba(26, 46, 26, 0.7);
            color: var(--text-light);
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--army-gold);
            box-shadow: 0 0 0 2px rgba(200, 176, 114, 0.3);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .nav-controls {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--army-dark-green);
            color: var(--army-gold);
            border: 1px solid var(--army-gold);
        }
        
        .btn-primary {
            background: var(--army-gold);
            color: var(--army-dark-green);
            border: 1px solid var(--army-gold);
        }
        
        .btn-warning {
            background: var(--danger);
            color: white;
            border: 1px solid var(--danger);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            border: 1px solid var(--success);
        }
        
        .question-page {
            display: none;
        }
        
        .question-page:first-child {
            display: block;
        }
        
        /* Icons */
        .fas, .far {
            width: 18px;
            height: 18px;
        }

        /* Confirmation Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 15% auto;
            padding: 30px;
            border: 2px solid var(--army-gold);
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            color: var(--text-light);
        }

        .modal h3 {
            color: var(--army-gold);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal p {
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .modal-btn-confirm {
            background: var(--success);
            color: white;
        }

        .modal-btn-cancel {
            background: var(--danger);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Top area overlay to prevent fullscreen controls */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            z-index: 9999998;
            background: rgba(0, 0, 0, 0.01);
            pointer-events: auto;
            display: none;
        }

        body:fullscreen .fullscreen-overlay,
        body:-webkit-full-screen .fullscreen-overlay,
        body:-moz-full-screen .fullscreen-overlay {
            display: block;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .exam-container {
                flex-direction: column;
            }
            
            .options-container {
                grid-template-columns: 1fr !important;
            }
        }

        /* Additional fullscreen protection */
        *:fullscreen::backdrop,
        *:-webkit-full-screen::backdrop,
        *:-moz-full-screen::backdrop {
            background-color: #000 !important;
        }

        /* Block all hover effects in fullscreen top area */
        body:fullscreen * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

    </style>
</head>

<body>

     <div id="fullscreenOverlay" style="
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:#000;color:#fff;z-index:9999;
        display:flex;align-items:center;justify-content:center;
        flex-direction:column;text-align:center;">
        <h2 style="margin-bottom:20px;">Your exam will start in Fullscreen Mode</h2>
        <button id="enterFullscreenBtn" style="
            font-size:20px;padding:15px 25px;
            background:#c8b072;color:#000;
            border:none;border-radius:8px;cursor:pointer;">
             Start Exam
        </button>
    </div>

    <!-- Top overlay to block fullscreen controls -->
    <div class="fullscreen-overlay" id="topOverlay"></div>

    <!-- Fullscreen Exit Warning Modal -->
    <div id="fsExitModal" class="modal" style="display:none; z-index: 10000;">
        <div class="modal-content">
            <div class="modal-icon warning" style="color: #f39c12; font-size: 48px; margin-bottom: 20px;">⚠️</div>
            <h2>Fullscreen Exited</h2>
            <p>You have exited fullscreen mode. <br>
            If this was accidental, please click "Return to Exam" immediately.<br>
            Otherwise, you must submit your exam.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" id="returnToExamBtn">
                    Return to Exam
                </button>
                <button class="modal-btn modal-btn-cancel" id="submitExamBtn" style="background-color: #ff0000;">
                    Submit Exam
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3>⚠️ Submit Exam Confirmation</h3>
            <p>Are you sure you want to submit your exam?<br>
            Once submitted, you cannot make any changes.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" id="confirmSubmit">
                    ✓ Yes, Submit Exam
                </button>
                <button class="modal-btn modal-btn-cancel" id="cancelSubmit">
                    ✗ Cancel
                </button>
            </div>
        </div>
    </div>

<div id="examContent" style="display:none;">
    <div class="exam-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Question Navigator</h2>
                <div class="time-remaining">
                    <i class="far fa-clock"></i> Time Left: <span id="timer">03:00:00</span>
                </div>
            </div>

            <div class="question-nav-container">
                <div class="question-nav">
                    {% for question in questions %}
                    <button type="button"
                            class="question-btn {% if forloop.first %}current{% endif %}"
                            id="nav-btn-{{ question.id }}"
                            onclick="showQuestion({{ forloop.counter0 }})">
                        {{ forloop.counter }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div class="question-status">
                <div class="status-item"><div class="status-color status-current"></div> Current Question</div>
                <div class="status-item"><div class="status-color status-answered"></div> Answered</div>
                <div class="status-item"><div class="status-color status-flagged"></div> Flagged</div>
                <div class="status-item"><div class="status-color status-not-answered"></div> Not Answered</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="exam-header">
                <h1 class="exam-title">{{ paper.question_paper }}{% if paper.trade %} — {{ paper.trade }}{% endif %}</h1>
            </div>

            <form method="post" id="exam-form" action="{% url 'exam_interface' %}">
                {% csrf_token %}
                <input type="hidden" name="session_id" value="{{ session.id }}">
                <input type="hidden" name="paper_id" value="{{ paper.id }}">

                {% for question in questions %}
                <div class="question-card question-page" id="question-{{ forloop.counter0 }}" style="{% if not forloop.first %}display:none{% endif %}">
                    <div class="question-header">
                        <h2 class="question-text">Q{{ forloop.counter }}. {{ question.text }}</h2>
                        <span class="marks-badge">{{ question.marks }} Marks</span>
                    </div>

                    <div class="options-container">
                        {# MCQ parts A/B: robust handling for different shapes of question.options #}
                        {% if question.part in "AB" %}
                            {% comment %} Prefer legacy dict shape: question.options.choices {% endcomment %}
                            {% if question.options and question.options.choices %}
                                {% for choice in question.options.choices %}
                                    {% if choice %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="question_{{ question.id }}"
                                               id="q{{ question.id }}_opt{{ forloop.counter }}"
                                               value="{{ choice }}"
                                               onchange="markAnswered({{ question.id }})">
                                        <label class="form-check-label" for="q{{ question.id }}_opt{{ forloop.counter }}">{{ choice }}</label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif question.options %}
                                {# options might be a list/array #}
                                {% for choice in question.options %}
                                    {% if choice %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="question_{{ question.id }}"
                                               id="q{{ question.id }}_opt{{ forloop.counter }}"
                                               value="{{ choice }}"
                                               onchange="markAnswered({{ question.id }})">
                                        <label class="form-check-label" for="q{{ question.id }}_opt{{ forloop.counter }}">{{ choice }}</label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {# fallback to a text input if no choices are available #}
                                <input type="text" name="question_{{ question.id }}" class="form-control" placeholder="Answer" onchange="markAnswered({{ question.id }})">
                            {% endif %}
                        
                        {% elif question.part == "C" %}
                            {# Short answer text area #}
                            <textarea name="question_{{ question.id }}" 
                                      rows="3" 
                                      class="form-control long-answer-input"
                                      data-question-index="{{ forloop.counter0 }}"
                                      placeholder="Type your detailed answer (30-50 words)" 
                                      onchange="markAnswered({{ question.id }})"></textarea>
                        {% elif question.part == "D" %}
                            {# Fill in the blanks - must be textbox (Part D) #}
                            <input type="text" 
                                   name="question_{{ question.id }}" 
                                   class="form-control fill-blank-input"
                                   data-question-index="{{ forloop.counter0 }}"
                                   placeholder="Enter your answer" 
                                   onchange="markAnswered({{ question.id }})">
                        {% elif question.part == "E" %}
                            {# Long answer text area #}
                            <textarea name="question_{{ question.id }}" 
                                      rows="4" 
                                      class="form-control long-answer-input"
                                      data-question-index="{{ forloop.counter0 }}"
                                      placeholder="Type your detailed answer (100-120 words)" 
                                      onchange="markAnswered({{ question.id }})"></textarea>
                        {% elif question.part == "F" %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_true" value="True." onchange="markAnswered({{ question.id }})">
                                <label class="form-check-label" for="q{{ question.id }}_true">True</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_false" value="False." onchange="markAnswered({{ question.id }})">
                                <label class="form-check-label" for="q{{ question.id }}_false">False</label>
                            </div>
                        {% else %}
                            {# Catch-all fallback #}
                            <input type="text" name="question_{{ question.id }}" class="form-control" onchange="markAnswered({{ question.id }})">
                        {% endif %}
                    </div>

                    <div class="nav-controls">
                        {% if not forloop.first %}
                        <button type="button" class="btn btn-secondary" onclick="prevQuestion({{ forloop.counter0 }})">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-warning" onclick="flagQuestion({{ question.id }})">
                            <i class="fas fa-flag"></i> Flag
                        </button>
                        {% if not forloop.last %}
                        <button type="button" class="btn btn-primary" onclick="nextQuestion({{ forloop.counter0 }})">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-success" id="final-submit">
                            <i class="fas fa-paper-plane"></i> Submit Exam
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let examSubmitted = false;
  let isWindowFocused = true;
  let altPressed = false;
  
  // ---------------------------
  // CSRF Token Management
  // ---------------------------
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  function getCSRFToken() {
    return getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
  }
  
  // Ensure CSRF token is present in form
  const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!csrfInput) {
    const form = document.getElementById('exam-form');
    if (form) {
      const token = getCSRFToken();
      if (token) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrfmiddlewaretoken';
        input.value = token;
        form.appendChild(input);
      }
    }
  }

  // ---------------------------
  // Fullscreen helpers (always return a Promise)
  // ---------------------------
  function enterFullScreen() {
    const el = document.documentElement;
    const fn =
      el.requestFullscreen ||
      el.mozRequestFullScreen ||
      el.webkitRequestFullscreen ||
      el.msRequestFullscreen;

    if (!fn) return Promise.reject(new Error("Fullscreen API not supported"));
    try {
      const maybe = fn.call(el);
      return (maybe && typeof maybe.then === "function") ? maybe : Promise.resolve();
    } catch (e) {
      return Promise.reject(e);
    }
  }

  function exitFullScreen() {
    const fn =
      document.exitFullscreen ||
      document.webkitExitFullscreen ||
      document.mozCancelFullScreen ||
      document.msExitFullscreen;

    if (!fn) return Promise.resolve();
    try {
      const maybe = fn.call(document);
      return (maybe && typeof maybe.then === "function") ? maybe : Promise.resolve();
    } catch {
      return Promise.resolve();
    }
  }

  // ---------------------------
  // Enhanced fullscreen control blocking
  // ---------------------------
  function blockFullscreenControls() {
    // Block mouse events near top of screen
    document.addEventListener('mousemove', (e) => {
      const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || 
                          document.mozFullScreenElement || document.msFullscreenElement;
      
      if (isFullscreen && e.clientY < 60) {
        e.preventDefault();
        e.stopImmediatePropagation();
        // Force cursor away from top
        document.body.style.cursor = 'none';
        setTimeout(() => {
          document.body.style.cursor = 'default';
        }, 200);
        return false;
      }
    }, { passive: false, capture: true });

    // Additional mouse event blocking
    ['mouseenter', 'mouseover', 'hover'].forEach(eventType => {
      document.addEventListener(eventType, (e) => {
        const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || 
                            document.mozFullScreenElement || document.msFullscreenElement;
        
        if (isFullscreen && e.clientY < 60) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }
      }, { passive: false, capture: true });
    });
  }

  // ---------------------------
  // Start Exam button
  // ---------------------------
  const startBtn = document.getElementById("enterFullscreenBtn");
  if (startBtn) {
    startBtn.addEventListener("click", () => {
      enterFullScreen()
        .then(() => {
          document.getElementById("fullscreenOverlay").style.display = "none";
          document.getElementById("examContent").style.display = "block";
          blockFullscreenControls();
        })
        .catch(err => {
          alert("Fullscreen is required to start the exam. Please allow fullscreen.");
          console.error(err);
        });
    });
  }

  // ---------------------------
  // Treat unexpected fullscreen exit as termination
  // ---------------------------
  function onFsChange() {
    const inFs =
      document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.mozFullScreenElement ||
      document.msFullscreenElement;

    if (!inFs && !examSubmitted) {
      // Show custom modal instead of immediate termination
      const fsModal = document.getElementById('fsExitModal');
      if (fsModal) {
          fsModal.style.display = 'block';
      } else {
          // Fallback
          if(confirm("You exited fullscreen. Click OK to Resume, Cancel to Terminate.")) {
              enterFullScreen();
          } else {
              window.location.replace("/candidate/login");
          }
      }
    }
  }
  document.addEventListener("fullscreenchange", onFsChange);
  document.addEventListener("webkitfullscreenchange", onFsChange);
  document.addEventListener("mozfullscreenchange", onFsChange);
  document.addEventListener("MSFullscreenChange", onFsChange);

  // FS Modal Listeners
  const returnBtn = document.getElementById('returnToExamBtn');
  const submitBtn = document.getElementById('submitExamBtn');
  
  if (returnBtn) {
      returnBtn.addEventListener('click', () => {
          document.getElementById('fsExitModal').style.display = 'none';
          enterFullScreen().catch(err => {
              console.error("Failed to re-enter fullscreen:", err);
              alert("Could not re-enter fullscreen. Please try again.");
          });
      });
  }

  if (submitBtn) {
      submitBtn.addEventListener('click', () => {
          document.getElementById('fsExitModal').style.display = 'none';
          examSubmitted = true;
          exitFullScreen();
          
          const form = document.getElementById("exam-form");
          if (form) {
              // Ensure CSRF token is present
              const csrfInput = form.querySelector('[name=csrfmiddlewaretoken]');
              if (!csrfInput) {
                const token = getCSRFToken();
                if (token) {
                  const input = document.createElement('input');
                  input.type = 'hidden';
                  input.name = 'csrfmiddlewaretoken';
                  input.value = token;
                  form.appendChild(input);
                }
              }
              form.submit();
          } else {
              window.location.replace("/candidate/login");
          }
      });
  }

  // ---------------------------
  // Block Alt+Tab and other window switching
  // ---------------------------
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Alt') {
      altPressed = true;
    }
    
    // Block Alt+Tab, Alt+Shift+Tab, Cmd+Tab (Mac)
    if ((e.altKey && e.key === 'Tab') || 
        (e.metaKey && e.key === 'Tab') ||
        (altPressed && e.key === 'Tab')) {
      e.preventDefault();
      e.stopImmediatePropagation();
      alert("Switching windows/tabs is not allowed during the exam!");
      return false;
    }
  });

  document.addEventListener('keyup', (e) => {
    if (e.key === 'Alt') {
      altPressed = false;
    }
  });

  // Detect window focus loss (tab switching, Alt+Tab, etc.)
  window.addEventListener('blur', () => {
    if (!examSubmitted && isWindowFocused) {
      isWindowFocused = false;
      setTimeout(() => {
        if (!isWindowFocused && !examSubmitted) {
          alert("You switched away from the exam window. Your exam has been terminated.");
          examSubmitted = true;
          exitFullScreen();
          window.location.replace("/candidate/login");
        }
      }, 1000);
    }
  });

  window.addEventListener('focus', () => {
    isWindowFocused = true;
  });

  // ---------------------------
  // Prevent Cheating Actions
  // ---------------------------
  document.addEventListener("contextmenu", e => e.preventDefault());
  
  // Enhanced key prevention with Enter key handling for different input types
  document.addEventListener("keydown", e => {
    // Handle Enter key for exam inputs
    if (e.key === "Enter") {
      const target = e.target;
      
      // For fill-in-the-blank inputs (Part D) - move to next question
      if (target && target.classList.contains('fill-blank-input')) {
        e.preventDefault();
        const questionIndex = parseInt(target.getAttribute('data-question-index'));
        
        // Move to next question if not the last one
        if (questionIndex < (window.totalQuestions - 1)) {
          window.nextQuestion(questionIndex);
        } else {
          // On last question, show confirmation modal
          showConfirmationModal();
        }
        return;
      }
      
      // For long answer inputs (Part E) - allow normal Enter behavior for new lines
      if (target && target.classList.contains('long-answer-input')) {
        // Don't prevent default - allow normal textarea behavior
        return;
      }
    }
    
    // Prevent other restricted keys
    if (
      e.key === "Escape" ||
      e.key === "F11" ||
      e.key === "F12" ||
      e.key === "F5" ||
      e.key === "F1" ||
      e.key === "F2" ||
      e.key === "F3" ||
      e.key === "F4" ||
      e.key === "F6" ||
      e.key === "F7" ||
      e.key === "F8" ||
      e.key === "F9" ||
      e.key === "F10" ||
      e.key === "PrintScreen" ||
      (e.ctrlKey && e.key.toLowerCase() === "w") ||
      (e.ctrlKey && e.shiftKey && ["i","j","c"].includes(e.key.toLowerCase())) ||
      (e.altKey && e.key === "Tab")
    ) {
      e.preventDefault();
      e.stopPropagation();
      alert("This action is disabled during the exam.");
    }
  });

  // ---------------------------
  // Confirmation Modal Functions
  // ---------------------------
  function showConfirmationModal() {
    document.getElementById('confirmationModal').style.display = 'block';
  }

  function hideConfirmationModal() {
    document.getElementById('confirmationModal').style.display = 'none';
  }

  // Modal event listeners
  document.getElementById('confirmSubmit').addEventListener('click', () => {
    hideConfirmationModal();
    examSubmitted = true;
    exitFullScreen();
    const form = document.getElementById("exam-form");
    if (form) {
      // Ensure CSRF token is present
      const csrfInput = form.querySelector('[name=csrfmiddlewaretoken]');
      if (!csrfInput) {
        const token = getCSRFToken();
        if (token) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'csrfmiddlewaretoken';
          input.value = token;
          form.appendChild(input);
        }
      }
      form.submit();
    }
  });

  document.getElementById('cancelSubmit').addEventListener('click', () => {
    hideConfirmationModal();
  });

  // Close modal when clicking outside
  document.getElementById('confirmationModal').addEventListener('click', (e) => {
    if (e.target.id === 'confirmationModal') {
      hideConfirmationModal();
    }
  });

  // ---------------------------
  // Submit (manual + auto)
  // ---------------------------
  const finalSubmitBtn = document.getElementById("final-submit");
  if (finalSubmitBtn) {
    finalSubmitBtn.addEventListener("click", () => {
      showConfirmationModal();
    });
  }

  const examForm = document.getElementById("exam-form");
  if (examForm) {
    examForm.addEventListener("submit", (e) => {
      if (!examSubmitted) {
        e.preventDefault();
        showConfirmationModal();
        return false;
      }
      examSubmitted = true;
      exitFullScreen();
    });
  }

  // Used by timer or external triggers
  window.endExam = function () {
    examSubmitted = true;
    exitFullScreen();
    alert("Time is up! Submitting your exam.");
    const form = document.getElementById("exam-form");
    if (form) {
      // Ensure CSRF token is present
      const csrfInput = form.querySelector('[name=csrfmiddlewaretoken]');
      if (!csrfInput) {
        const token = getCSRFToken();
        if (token) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'csrfmiddlewaretoken';
          input.value = token;
          form.appendChild(input);
        }
      }
      form.submit();
    }
  };

  // ---------------------------
  // Question navigation & state (exposed for inline onclick handlers)
  // ---------------------------
  let currentIndex = 0;
  const answeredQuestions = new Set();
  const flaggedQuestions = new Set();

  window.showQuestion = function (index) {
    document.querySelectorAll(".question-page").forEach(q => q.style.display = "none");
    const target = document.getElementById("question-" + index);
    if (target) target.style.display = "block";

    document.querySelectorAll(".question-btn").forEach((btn, i) => {
      btn.classList.toggle("current", i === index);
    });

    currentIndex = index;
  };

  window.nextQuestion = function (index) {
    if (index + 1 < (window.totalQuestions || 0)) window.showQuestion(index + 1);
  };

  window.prevQuestion = function (index) {
    if (index - 1 >= 0) window.showQuestion(index - 1);
  };

  window.flagQuestion = function (qid) {
    const btn = document.getElementById("nav-btn-" + qid);
    if (!btn) return;

    if (flaggedQuestions.has(qid)) {
      btn.classList.remove("flagged");
      flaggedQuestions.delete(qid);
      if (answeredQuestions.has(qid)) btn.classList.add("answered");
    } else {
      btn.classList.add("flagged");
      btn.classList.remove("answered");
      flaggedQuestions.add(qid);
      answeredQuestions.delete(qid);
    }
  };

  window.markAnswered = function (qid) {
    const btn = document.getElementById("nav-btn-" + qid);
    if (!btn) return;

    if (!flaggedQuestions.has(qid)) {
      btn.classList.add("answered");
      btn.classList.remove("flagged");
      answeredQuestions.add(qid);
    }
  };

  // ---------------------------
  // Timer
  // ---------------------------
  window.startTimer = function (duration, display) {
    let timer = duration;
    const intervalId = setInterval(() => {
      const h = String(Math.floor(timer / 3600)).padStart(2, '0');
      const m = String(Math.floor((timer % 3600) / 60)).padStart(2, '0');
      const s = String(timer % 60).padStart(2, '0');
      display.textContent = `${h}:${m}:${s}`;

      if (timer === 5 * 60) {
        display.style.color = 'red';
        display.style.animation = 'blink 1s infinite';
      }

      if (timer <= 0) {
        clearInterval(intervalId);
        examSubmitted = true;
        exitFullScreen();
        alert("Time is up! Submitting your exam.");
        const form = document.getElementById("exam-form");
    if (form) {
      // Ensure CSRF token is present
      const csrfInput = form.querySelector('[name=csrfmiddlewaretoken]');
      if (!csrfInput) {
        const token = getCSRFToken();
        if (token) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'csrfmiddlewaretoken';
          input.value = token;
          form.appendChild(input);
        }
      }
      form.submit();
    }
      }

      timer -= 1;
    }, 1000);
  };

  // ---------------------------
  // Init (timer + first question + blink style)
  // ---------------------------
  (function init() {
    const display = document.getElementById("timer");
    const duration = {{ duration_seconds|default:0 }};

    if (display && duration > 0) {
      startTimer(duration, display);
    }

    // totalQuestions from Django; fall back to 0
    window.totalQuestions = {{ questions|length|default:0 }};

    if (window.totalQuestions > 0) showQuestion(0);

    const style = document.createElement('style');
    style.textContent = `@keyframes blink { 50% { opacity: 0.5; } }`;
    document.head.appendChild(style);
  })();
});

// Prevent back/forward navigation
window.addEventListener("pageshow", function (e) {
    const nav = performance.getEntriesByType && performance.getEntriesByType("navigation")[0];
    const viaBFCache = e.persisted || (nav && nav.type === "back_forward");
    if (viaBFCache) location.reload();
});

// Enhanced fullscreen control prevention with multiple approaches
document.addEventListener('DOMContentLoaded', function() {
    let isInFullscreen = false;
    let mouseBlockTimer = null;
    
    // Track fullscreen state
    function updateFullscreenState() {
        isInFullscreen = !!(document.fullscreenElement || 
                           document.webkitFullscreenElement || 
                           document.mozFullScreenElement || 
                           document.msFullscreenElement);
    }

    // Listen for fullscreen changes
    ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange']
        .forEach(event => document.addEventListener(event, updateFullscreenState));

    // Block top area completely with multiple event handlers
    const blockEvents = ['mousemove', 'mouseenter', 'mouseover', 'hover', 'focus'];
    
    blockEvents.forEach(eventType => {
      document.addEventListener(eventType, function(e) {
          if (isInFullscreen && e.clientY < 60) {
              e.preventDefault();
              e.stopImmediatePropagation();
              
              // Hide cursor temporarily
              document.body.style.cursor = 'none';
              
              // Clear existing timer
              if (mouseBlockTimer) clearTimeout(mouseBlockTimer);
              
              // Restore cursor after delay
              mouseBlockTimer = setTimeout(() => {
                  document.body.style.cursor = 'default';
              }, 300);
              
              // Force focus back to document
              if (document.activeElement && typeof document.activeElement.blur === 'function') {
                  document.activeElement.blur();
              }
              document.body.focus();
              
              return false;
          }
      }, { passive: false, capture: true });
    });

    // Additional protection against any hover events
    document.addEventListener('pointerenter', function(e) {
        if (isInFullscreen && e.clientY < 60) {
            e.preventDefault();
            e.stopImmediatePropagation();
            document.body.style.cursor = 'none';
            setTimeout(() => {
                document.body.style.cursor = 'default';
            }, 200);
            return false;
        }
    }, { passive: false, capture: true });

    // Block any click events in top area
    document.addEventListener('click', function(e) {
        if (isInFullscreen && e.clientY < 60) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
    }, { passive: false, capture: true });

    // Continuous monitoring and blocking
    setInterval(() => {
        if (isInFullscreen) {
            const topOverlay = document.getElementById('topOverlay');
            if (topOverlay) {
                topOverlay.style.display = 'block';
                topOverlay.style.zIndex = '9999999';
            }
        }
    }, 100);
});

// Additional security measures
document.addEventListener('visibilitychange', function() {
    if (document.hidden && !examSubmitted) {
        setTimeout(() => {
            if (document.hidden && !examSubmitted) {
                alert("You switched away from the exam. Your exam has been terminated.");
                examSubmitted = true;
                window.location.replace("/candidate/login");
            }
        }, 1500);
    }
});

// Block developer tools
document.addEventListener('keydown', function(e) {
    // Block F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, etc.
    if (e.key === 'F12' || 
        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
        (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        e.stopPropagation();
        alert("Developer tools are disabled during the exam.");
        return false;
    }
});

// Detect dev tools opening (basic detection)
let devtools = {open: false, orientation: null};
setInterval(function() {
    if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
        if (!devtools.open && !examSubmitted) {
            devtools.open = true;
            alert("Developer tools detected. Your exam has been terminated.");
            examSubmitted = true;
            window.location.replace("/candidate/login");
        }
    } else {
        devtools.open = false;
    }
}, 500);

// Block text selection in fullscreen
document.addEventListener('selectstart', function(e) {
    if (document.fullscreenElement || document.webkitFullscreenElement || 
        document.mozFullScreenElement || document.msFullscreenElement) {
        e.preventDefault();
    }
});

// Block drag and drop
document.addEventListener('dragstart', function(e) {
    e.preventDefault();
});

// Block print
window.addEventListener('beforeprint', function(e) {
    e.preventDefault();
    alert("Printing is disabled during the exam.");
    return false;
});

// Block Ctrl+P
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        alert("Printing is disabled during the exam.");
        return false;
    }
});
</script>

</body>
</html>
